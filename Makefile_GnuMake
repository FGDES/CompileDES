#
# GNU-Make Makefile for libFAUDES application CompileDES for OsX, Linux and MSYS
#

# 
# Part 1: configure paths and tools
#

# set version information (optional)
COMPILEDES_VERSION = 3.14
DEFINES+= -DCOMPILEDES_VERSION=\"$(COMPILEDES_VERSION)\"

# libFAUDES compiled library and headers 
LIBFAUDES=./libFAUDES_lib

# target executrable
TARGET=compiledes

# optional: adapt filenames to environment
ifneq ($(findstring Darwin,$(shell uname -s)),)
LIBFAUDES=./libFAUDES_osx
TARGET=compiledes_osx
endif
ifneq ($(findstring Linux,$(shell uname -s)),)
LIBFAUDES=./libFAUDES_lx
TARGET=compiledes_lx
endif
ifneq ($(findstring MSYS,$(shell uname -s)),)
LIBFAUDES=./libFAUDES_msys
TARGET=compiledes_msys
endif

# compiler 
CXX= g++
INCLUDES=-I$(LIBFAUDES)/include
CFLAGS= $(INCLUDES) -Wall -c

# linker
LXX= g++
LFLAGS= -L$(LIBFAUDES) 
LIBS= $(LIBFAUDES)/libfaudes.a -lpthread

# doxygen (only needed for the target doc, see below)
DOXYGEN = doxygen




# 
# Part 2: CompileDES sources and targets
#

# source files
CPPSRC=\
  cgp_eventconfig.cpp cgp_codegenerator.cpp cgp_codeprimitives.cpp \
  cgp_embeddedc.cpp  cgp_atmega.cpp cgp_kinetis.cpp \
  cgp_iec61131st.cpp cgp_gebtools.cpp cgp_plcoxml.cpp
CPPMAIN=\
  compiledes.cpp

# std dirs
SRCDIR=src
BLDDIR=build
OBJDIR=build/obj
BINDIR=build

# adjust files to std dirs
HEADERS = $(CPPSRC:%.cpp=$(SRCDIR)/%.h) 
OBJECTS = $(CPPSRC:%.cpp=$(OBJDIR)/%.o) $(CPPMAIN:%.cpp=$(OBJDIR)/%.o)
EXECUTABLES := $(BINDIR)/$(TARGET)

# first target becomes the default
default: $(EXECUTABLES) $(EXESRC:%.cpp=$(OBJDIR)/%.o) $(OBJECTS)



# 
# Part 3: build rules
#

# prepare build dirs
PREPARE = $(OBJDIR)/.timestemp
$(PREPARE):
	@ - mkdir -p $(OBJDIR)
	@ touch $@
	@echo "installed build directories"

# .cpp -> .o
$(OBJDIR)/%.o: $(SRCDIR)/%.cpp $(HEADERS) $(PREPARE)
	$(CXX) $(CFLAGS) $(DEFINES) $< -o $@

# .o -> bin
$(BINDIR)/%: $(OBJECTS) $(PREPARE)
	$(LXX) $(LFLAGS) $(DEFINES) $(OBJECTS) $(LIBS) -o $@

# clean
clean:
	rm -f $(OBJECTS)  $(EXESRC:%.cpp=$(OBJDIR)/%.o)

# dist-clean
dist-clean: clean
	@ - rm $(BLDDIR)/*
	@ - rm $(OBJDIR)/*
	@echo "removed all generated files"



# 
# Part 4: documentation
#

# Note: since I could not restrain to personalise the footer/header/css to my
# preferences, the doc target requires a doxygen version close to mine, i.e., 
# 1.8 series. For other versions, a plain "doxygen" manually invoked within 
# "compiledes/src/" should produce reasonable output in "./compile/src/doc/html".
# Check the doxygen manuals, its worth it.

# run doxygen
doc:
	@echo running doxygen
	@ ( cat src/doxygen.conf ; \
              echo "PROJECT_NUMBER = \"$(COMPILEDES_VERSION)\"" ; \
        ) | $(DOXYGEN) - 


# explicit targets
.PHONY: doc




